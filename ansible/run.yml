- hosts: all
  become: yes 
  vars:
    ############### MODIFY VARIABLES AS NEEDED ###############
    user: claudia
    bucket: 'tcp-c-3'
    gs_access_key: 'GOOGNVTBQEKU373GCYLUNPMH'
    gs_secret_key: 'IY4ag+Ya3Cg0ZrODWsOA7ScAeTM2lIH2nDsShulM'
    path: "/home/{{ user }}/tpc-c-0.1-SNAPSHOT"
    workload_file: "{{ path }}/etc/workload-config.properties"

    # Workload properties:
    number_warehouses: 10
    measurement_time: 10
    number_clients_wharehouse: 10
    ##########################################################
  tasks:
    - name: Replace number of warehouses
      replace:
        path: "{{ workload_file }}"
        regexp: "^tpcc.number.warehouses=.*"
        replace: "tpcc.number.warehouses={{ number_warehouses }}"

    - name: Replace measurement time
      replace:
        path: "{{ workload_file }}"
        regexp: "^measurement.time=.*"
        replace: "measurement.time={{ measurement_time }}"

    - name: Replace number of clients per warehouse
      replace:
        path: "{{ workload_file }}"
        regexp: "^tpcc.numclients=.*"
        replace: "tpcc.numclients={{ number_clients_wharehouse }}"

    - name: Replace total clients
      replace:
        path: "{{ workload_file }}"
        regexp: "^clients=.*"
        replace: "clients={{ number_clients_wharehouse * number_warehouses }}"

    - name: Set think time to true
      replace:
        path: "{{ workload_file }}"
        regexp: "^measurement.think.time=.*"
        replace: "measurement.think.time=true"

    - name: Run script
      shell: "./run.sh"
      args:
        chdir: "{{ path }}"

    - name: Find result file from run
      find:
        paths: "{{ path }}"
        age: '-10'
        age_stamp: ctime
        patterns: "^.*\\.dat$"
        use_regex: yes
      register: file

    - name: Upload result file to bucket
      gc_storage:
        bucket: "{{ bucket }}"
        gs_access_key: "{{ gs_access_key }}"
        gs_secret_key: "{{ gs_secret_key }}"
        object: "{{ file.files[0].path.split('/')[4] }}"
        src: "{{ file.files[0].path }}"
        mode: put
        permission: public-read
